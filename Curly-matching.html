<script>
  class Candidates {
    constructor(employer) {
      this.email = employer._accountDetails().email
      this.id = employer._accountDetails().id
      this.candidatesCountValue = null
      this.activeCandidatesCountValue = null
      this.newCandidatesCountValue = null
      this.pagination = 2
    }
    async _getCandidatesStats() {
      const response = await fetchData("https://api.baserow.io/api/database/rows/table/118042/?filter__field_1007785__link_row_contains=" + this.email); 
        const candidatesCounts = document.querySelectorAll('[data-candidates-count]')
        const newCandidatesCount = document.querySelector('[data-new-candidates]')
        const activeCandidatesCount = document.querySelector('[data-active-candidates]')
          if(this.candidatesCountValue!=response.data.count) {
            candidatesCounts.forEach(candidatesCount=>candidatesCount.textContent = response.data.count)
              this.candidatesCountValue = response.data.count
              const currentDate = new Date().toISOString().split("T")[0]; // Get the current date in "YYYY-MM-DD" format
              const newCandidates = response.data.results.filter(item => {
              const itemDate = item.field_751776.split("T")[0]; // Extract the date from the "create_at" field
              return itemDate === currentDate; // Compare the item's date with the current date
              });
  
            console.log(newCandidates,newCandidates.length, "filteredResults");
  
            const inActiveStatus = ["hired", "invited", "rejected"]
            const activeCandidates = response.data.results.filter(item => {
            const isActive = !inActiveStatus.includes(item.field_826075.value.toLowerCase()); 
            return isActive; 
            });
            console.log(activeCandidates,activeCandidates.length, "activeCandidates")
          if(this.activeCandidatesCountValue!=activeCandidates.length) {
            this.activeCandidatesCountValue = activeCandidates.length
            activeCandidatesCount.textContent = this.activeCandidatesCountValue
          }
          if(this.newCandidatesCountValue!=newCandidates.length) {
            newCandidatesCount.textContent = newCandidates.length
            this.newCandidatesCountValue = newCandidates.length
           }
           const results = response.data.results;
          // Create an object to store the grouped results
          const groupedResults = {};
  
          // Group the results by field_826075.value
          results.forEach(item => {
            const groupKey = item.field_826075.value;
  
            // Check if the group key is not null or undefined
            if (groupKey !== null && groupKey !== undefined) {
              if (groupedResults.hasOwnProperty(groupKey)) {
                groupedResults[groupKey].push(item);
              } else {
                groupedResults[groupKey] = [item];
              }
            }
          });
        document.querySelector('[data-invite-count]').textContent = groupedResults['Invite']?.length ?? 0
        document.querySelector('[data-applied-count]').textContent = groupedResults['Applied']?.length ?? 0
        document.querySelector('[data-interviewed]').textContent = groupedResults['Interviewed']?.length ?? 0
        document.querySelector('[data-test-count]').textContent = groupedResults['Test']?.length ?? 0
        document.querySelector('[data-hired-count]').textContent = groupedResults['Hired']?.length ?? 0
        document.querySelector('[data-rejected-count]').textContent = groupedResults['Rejected']?.length ?? 0
      }
     }
    async _loadCandidates(desiredPage) {
      console.log(this.id, "no id?")
      if(!this.id || !desiredPage) {
        return 
      }
      fetchData(`https://api.baserow.io/api/database/rows/table/118042/?filter__field_1007785__link_row_has=${this.id}&page=${desiredPage}&size=${this.pagination}`).then(value =>{
        console.log(value, "any problem1?")
        if(value.data.count > 0) {
          console.log(value, "any problem2?")
            $.each(value.data.results, function(key,candidate){
                const dateTime = new Date(candidate.field_751776)
                const timeOnly = dateTime.toLocaleTimeString()
                const dateOnly =  dateTime.toLocaleDateString()
                var obj = {
                  id					: candidate.id,
                  title 			: candidate.field_1026493[0].value,
                  professional_id  : candidate.field_768138[0].id,
                  name  			: candidate.field_768139[0].value,
                  initials : getInitials(candidate.field_768139[0].value),
                  email       : candidate.field_751967,
                  location  	: candidate.field_768140[0].value +", "+candidate.field_845523[0].value,
                  experience  : candidate.field_845525[0].value,
                  type				: candidate.field_1024105[0].value,
                  dateapplied : dateOnly,
                  picurl  		: candidate.field_845539[0].value || default_picture,
                  applicationStatus : candidate.field_826075.value,
                  verified : candidate.field_1024367[0].value.value,
                  language : candidate.field_1026501[0].value,
                  english_level : candidate.field_1053047[0].value.value,
                  position : candidate.field_1026500[0].value,
                  trade : candidate.field_1026502[0].value,
                  skills : candidate.field_1026503[0].value,
                  stage : candidate.field_826075.value
                }
                //const isVerified =  obj.verified == "Verified" 
                const verifiedIcon = obj.verified == "Verified" ? "https://assets.website-files.com/62a1fe4a88d6da5f8b5232b4/6442beb8a200b03c7bca5fae_Circle%20Check.svg" : ""
                 console.log(obj.verified)
                //array_candidates.push(obj)
            $("#results-container").append( 
            `
             <tr class = "candidate-row">
            <td>
               <div class="candidates-job-title-container">
                <div class="candidate-td-content candidates-card-mobile-view">
                <div class="user-initial-name">${obj.initials}</div>
                  <a href="#" class="candidate-name-and-badge-icon w-inline-block">
                    <div class="candidate-name">${obj.name}</div><div class="candidate-badge-content">
                    <img src="${verifiedIcon}" loading="lazy" alt="" class="candidate-badge-icon">
                    </div>
                   </a>
                  </div>
              </div>
            </td>
            <td>
              <div class="candidate-td-content candidates-card-mobile-view job-title">
              <div class="user-initial-name empty-for-alignment" style = "visibility : hidden"></div>
              <div class="candidate-td-text">${obj.title}</div>
              </div>
            </td>
  
            <td>
              <div class = "candidate-td-content">
                <div class="candidates-td-label">Experience</div><div class="candidate-td-text">${obj.experience}</div>
              </div>
            </td>
            <td>
              <div class = "candidate-td-content" >
               <div class="candidates-td-label">Job type</div><div class="candidate-td-text">${obj.type}</div>
             </div>
            </td>
        </tr>
            `
            )  
          })
            // loadDataTable()
             if(value.data.next == null) {
            $("#load-more-button").hide()
          } else {
            $("#load-more-button").attr("onclick", `loadCandidates('${++currentPage }')`)
          }
         
        }
       })
    }
  }
  </script>